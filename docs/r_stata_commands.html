<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Chuck Lanfear" />


<title>R and Stata Equivalencies</title>

<script src="r_stata_commands_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="r_stata_commands_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="r_stata_commands_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="r_stata_commands_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="r_stata_commands_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="r_stata_commands_files/navigation-1.1/tabsets.js"></script>
<link href="r_stata_commands_files/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="r_stata_commands_files/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->





<div class="fluid-row" id="header">



<h1 class="title toc-ignore">R and Stata Equivalencies</h1>
<h4 class="author"><em>Chuck Lanfear</em></h4>
<h4 class="date"><em>Updated 9:07 PM, March 14, 2019</em></h4>

</div>


<style>
.column-left{
  float: left;
  width: 48%;
  text-align: left;
}
.column-right{
  float: right;
  width: 48%;
  text-align: left;
}
.column-center{
  float: right;
  width: 100%;
  text-align: left;
}
</style>
<p>This document depicts both Stata and R approaches to data management, modeling, and plotting seen in SOC505. They are presented side-by-side to make it easier to move between platforms. It also demonstrates that Stata and R are quite similar in syntax in many cases. R often takes more code to do common tasks than Stata, but can do many things that are not possible in Stata. Both are excellent platforms for quantitative research, though Stata is more common in economics and R is more common in statistics and data science.</p>
<div class="column-center">
<h2 id="loading-data">Loading Data</h2>
<p>Provided a Stata data set (<code>.dta</code> file), we can read it into either Stata or R.</p>
</div>
<div class="column-left">
<h4 id="stata">Stata</h4>
<p>Stata can only load one data set at a time, so it does not get assigned to an object.</p>
<pre><code>use example_data.dta</code></pre>
<p>This will load from Stata’s current working directory. You can change the working directory using <code>cd "path"</code> (e.g. <code>cd "C:\Users\me\documents"</code>).</p>
</div>
<div class="column-right">
<h4 id="r">R</h4>
<p>R can load an arbitrary number of data sets at once, so they must each be assigned a name. I recommend <code>read_dta()</code> in the <code>haven</code> package–part of the <code>tidyverse</code>–for loading Stata files because it preserves Stata labels.</p>
<pre><code>example_data &lt;- haven::read_dta(&quot;example_data.dta&quot;)</code></pre>
<p>R will load this file from your current working directory. If using a .Rmd file, this will default to the directory the .Rmd file is in. You can change the working directory with <code>setwd("path")</code> (e.g. <code>setwd("C:\Users\me\documents")</code>).</p>
</div>
<div class="column-center">
<h2 id="creating-example-data">Creating Example Data</h2>
<p>For the first homework, we created a sample of simulated data with a specified covariance matrix and means.</p>
</div>
<div class="column-left">
<h4 id="stata-1">Stata</h4>
<pre><code>matrix mean_vec=(1.0, 2.0, 3.0)
matrix cov_mat=(1.0, .75, 1.0  \ /// 
                .75, 1.5, 0.0  \ ///  
                1.0, 0.0, 2.0)            
corr2data x y z, n(300) mean(mean_vec) ///
   cov(cov_mat) cstorage(full) seed(341305)</code></pre>
<p>In Stata we create a vector of means (named <code>m</code> here) and a matrix of covariances (named <code>vc</code>). <code>corr2data</code> then generates data with variables named <code>x</code>, <code>y</code>, and <code>z</code> whose means (<code>mean(m)</code>) and covariances (<code>cov(vc)</code>) match what we provided. We specify the sample size with <code>n()</code>.</p>
</div>
<div class="column-right">
<h4 id="r-1">R</h4>
<pre><code>mean_vec &lt;- c(&quot;x&quot; = 1.0, &quot;y&quot; = 2.0, &quot;z&quot; = 3.0)
cov_mat &lt;- rbind(c(1.0, .75, 1.0),
                 c(.75, 1.5, 0.0),
                 c(1.0, 0.0, 2.0))
example_data &lt;- data.frame(MASS::mvrnorm(300,
                            mu = mean_vec, 
                            Sigma = cov_mat,
                            empirical = TRUE))</code></pre>
<p>In R, the operation is similar to Stata. We provide a vector of means (<code>mean_vec</code>) and a covariance matrix (<code>cov_mat</code>). Note we create vectors with <code>c()</code> and combined them into a matrix by rows with <code>rbind()</code> (row bind). <code>mvrnorm()</code> in the <code>MASS</code> has number of observations (<code>300</code>) as its first argument. <code>::</code> allows us to use a function from a package without loading the whole package.</p>
</div>
<div class="column-center">
<h2 id="creating-variables">Creating Variables</h2>
<p>R and Stata are very different with regard to storing, accessing, and modifying data and variables. Stata only loads one data set at a time. R stores all object including data as objects and can have an arbitrary number loaded at once. Below I create an interaction term between <code>x</code> and <code>z</code> and a discrete version of <code>x</code>.</p>
</div>
<div class="column-left">
<h4 id="stata-2">Stata</h4>
<p>In Stata, we just use <code>generate</code> and the variable is created in our current data.</p>
<pre><code>generate x_z = x * z
generate x_disc = 0
replace x_disc = 1 if x &lt; .5
replace x_disc = 2 if x &gt; .5 &amp; x &lt; 1.5
replace x_disc = 3 if x &gt; 1.5</code></pre>
</div>
<div class="column-right">
<h4 id="r-2">R</h4>
<p>In R, we assign variables inside the data we want to use. We can do this with base R:</p>
<pre><code>example_data$x_z &lt;- example_data$x * example_data$z
example_data$x_disc &lt;- 
  ifelse(example_data$x &lt; .5, 1, 
    ifelse(example_data$x &gt; .5 &amp; example_data$x &lt; 1.5, 2,
      ifelse(example_data$x &gt; 1.5, 3, 0)))</code></pre>
<p>Note here I chained three <code>ifelse()</code> statements together in one call. This is complex, but powerful.</p>
<p>Or we can use the <code>dplyr</code> package:</p>
<pre><code>example_data &lt;- example_data %&gt;% mutate(x_z = x * z)
example_data &lt;- example_data %&gt;% 
  mutate(x_disc =
    case_when(
      x &lt; .5 ~ 1,
      x &gt; .5 &amp; x &lt; 1.5 ~ 2,
      x &gt; 1.5 ~ 3
    ))</code></pre>
<p><code>case_when()</code> does seuqential <code>ifelse()</code> statements but is much more readable.</p>
</div>
<div class="column-center">
<h2 id="linear-models">Linear Models</h2>
<p>Modeling commands are very similar between R and Stata. The primary difference is that R argument go inside paranthesis rather than just after the name of the command as in Stata. Stata options come after a comma and are separate from formulae, but all R arguments–including formulae–are treated the same and separated by commas. Default R output is simpler than Stata: use <code>summary()</code> if you want Stata-like output. In Stata, you save model output using <code>estimates store</code> while in R you just assign the model object to a name. Note we specified which data we are using in R: R can have many data sets loaded at the same time!</p>
</div>
<div class="column-left">
<h4 id="stata-3">Stata</h4>
<pre><code>glm y x z, ///
   family(gaussian) link(identity)
estimates store example_model</code></pre>
<p>Note in the above examples, a single Stata command can be spread over multiple lines using <code>///</code>.</p>
</div>
<div class="column-right">
<h4 id="r-3">R</h4>
<pre><code>example_model &lt;- glm(y ~ x + z,
                     family = gaussian(link = &quot;identity&quot;),
                     data = example_data)
summary(example_model)</code></pre>
<p>In R, all commands can span multiple lines so long as each line (other than the last) ends in an operator (e.g. <code>,</code> as above, but also <code>+</code> like in <code>ggplot2</code> calls).</p>
</div>
<div class="column-center">
<h2 id="linear-hypotheses">Linear Hypotheses</h2>
<p>Linear hypotheses are used to test restrictions on models (e.g. that a coefficient is zero or equal to another).</p>
</div>
<div class="column-left">
<h4 id="stata-4">Stata</h4>
<pre><code>test x=0
test x=z
test x=z=0</code></pre>
<p>Like most postestimation commands in Stata, linear hypotheses (with <code>test</code>) must be conducted immediately after running the model of interest.</p>
</div>
<div class="column-right">
<h4 id="r-4">R</h4>
<pre><code>car::linearHypothesis(example_model, &quot;x=0&quot;)
car::linearHypothesis(example_model, &quot;x=z&quot;)
car::linearHypothesis(example_model, c(&quot;x=0&quot;, &quot;z=0&quot;))</code></pre>
<p>In R, they must be run using a saved model object (like <code>example_model</code> created above). In R, the <code>linearHypothesis()</code> function is found in the <code>car</code> package. You can obtain this package using <code>install.packages("car")</code>. You can then either use <code>library(car)</code> to load the package or run <code>linearHypothesis()</code> from car directly–without loading the package–using <code>car::linearHypothesis()</code> as below.</p>
</div>
<div class="column-center">
<h2 id="residuals">Residuals</h2>
<p>We often want to obtain residuals to check model fit or produce plots where we have controlled for covariates.</p>
</div>
<div class="column-left">
<h4 id="stata-5">Stata</h4>
<pre><code>predict residual_y_xz, deviance // GLM uses deviance 
predict residual_y_xz, residual // OLS uses residual</code></pre>
<p>Obtaining residuals is a postestimation command in Stata, which must be run immediately after a model.</p>
</div>
<div class="column-right">
<h4 id="r-5">R</h4>
<pre><code>residual_y_xz &lt;- residuals(example_model)
example_data$residual_y_xz &lt;- residuals(example_model)</code></pre>
<p>In R, we run the command on a saved model object. If you want to save the residuals to the original data, you can just assign them as a column.</p>
</div>
<div class="column-center">
<h2 id="dummy-variables">Dummy Variables</h2>
<p>Dummy variables can be prepared for models in two ways: Creating individual dummy variables or specifying them in the model formula. I prefer to store categorical data as factors or strings (character data). This way you don’t confuse them with numeric variables.</p>
<h3 id="dummies-in-formula">Dummies in Formula</h3>
<p>We can specify dummies directly in the formula in either Stat or R.</p>
</div>
<div class="column-left">
<h4 id="stata-6">Stata</h4>
<p>In Stata, we just use append our categorical variable with <code>i.</code>:</p>
<pre><code>glm y i.x_disc </code></pre>
</div>
<div class="column-right">
<h4 id="r-6">R</h4>
<p>In R, variables stored as factors automatically turn into dummies:</p>
<pre><code>glm(y ~ factor(x_disc), data=example_data)</code></pre>
<p>Note if you assigned it as a factor when you created or loaded the data, you don’t need to specify it as a factor in the formula.</p>
</div>
<div class="column-center">
<h3 id="dummies-in-data">Dummies in Data</h3>
<p>We can also manually create dummies in the actual data (Jerry’s preference)</p>
</div>
<div class="column-left">
<h4 id="stata-7">Stata</h4>
<p>We can either generate each dummy individually or use a <code>tabulate</code> shortcut.</p>
<pre><code>generate x_d1 = 0
replace x_d1 = 1 if x_disc==1
generate x_d2 = 0
replace x_d2 = 2 if x_disc==2
generate x_d3 = 0
replace x_d3 = 3 if x_disc==3

tabulate x_disc, generate(x_d)</code></pre>
</div>
<div class="column-right">
<h4 id="r-7">R</h4>
<p>Base R:</p>
<pre><code>example_data$x_d1 &lt;- ifelse(example_data$x_disc==1, 1, 0)
example_data$x_d2 &lt;- ifelse(example_data$x_disc==2, 1, 0)
example_data$x_d3 &lt;- ifelse(example_data$x_disc==3, 1, 0)</code></pre>
<p><code>dplyr</code>:</p>
<pre><code>example_data &lt;- example_data %&gt;%
  mutate(x_d1 = ifelse(x_disc==1, 1, 0),
         x_d2 = ifelse(x_disc==2, 2, 0),
         x_d3 = ifelse(x_disc==3, 3, 0))</code></pre>
</div>
<div class="column-center">
<h2 id="tables">Tables</h2>
</div>
<div class="column-left">
<h4 id="stata-8">Stata</h4>
<pre><code>tab x_disc
tab x_d1 x_d2</code></pre>
</div>
<div class="column-right">
<h4 id="r-8">R</h4>
<p>Base R:</p>
<pre><code>table(example_data$x_disc)
table(example_data$x_d1, example_data$x_d2)
</code></pre>
<p><code>dplyr</code>:</p>
<pre><code>example_data %&gt;% count(x_disc)
example_data %&gt;% count(x_d1, x_d2)</code></pre>
</div>
<div class="column-center">
<h2 id="logit-models">Logit Models</h2>
<p>Logistic regression is a generalized linear model for binomially distributed data which uses a logit function link.</p>
</div>
<div class="column-left">
<h4 id="stata-9">Stata</h4>
<p>Stata offers multiple commands for running a logistic regression. <code>glm</code> and <code>logit</code> report log-odds coefficients while <code>logistic</code> reports odds ratios. <code>logit</code> is just a shortcut for <code>glm</code> to save typing out the family and link.</p>
<pre><code>glm x_d1 y z, family(binomial) link(logit)
logit x_d1 y z
logistic x_d1 y z
</code></pre>
</div>
<div class="column-right">
<h4 id="r-9">R</h4>
<p>R uses <code>glm()</code> for logistic regression.</p>
<pre><code>example_model2 &lt;- 
  glm(x_d1 ~ y + z,
      family = binomial(link = &quot;logit&quot;),
      data = example_data)
summary(example_model2)</code></pre>
<p>To obtain odds ratios, exponentiate the log-odds coefficients and/or their confidence intervals:</p>
<pre><code>exp(coef(example_model2))
exp(confint(example_model2))</code></pre>
</div>
<div class="column-center">
<h1 id="plotting">Plotting</h1>
<h2 id="scatterplots">Scatterplots</h2>
</div>
<div class="column-left">
<h4 id="stata-10">Stata</h4>
<pre><code>scatter y x</code></pre>
</div>
<div class="column-right">
<h4 id="r-10">R</h4>
<p>Base R scatterplots use <code>plot()</code> and can take either a formula or <code>x</code> and <code>y</code> arguments:</p>
<pre><code>plot(example_data$y ~ example_data$x)
plot(example_data$x, example_data$y)</code></pre>
<p><code>gplot2</code> uses <code>geom_point()</code>:</p>
<pre><code>ggplot(example_data, aes(x, y)) + 
  geom_point()</code></pre>
</div>
<div class="column-center">
<h3 id="fit-lines-on-scatterplots">Fit Lines on Scatterplots</h3>
<p>Often we want to plot regression lines on our scatterplots.</p>
</div>
<div class="column-left">
<h4 id="stata-11">Stata</h4>
<p>We can just draw both the scatter and a linear fit (<code>lfit</code>) at the same time:</p>
<pre><code>graph twoway ((scatter y x) || (lfit y x))</code></pre>
</div>
<div class="column-right">
<h4 id="r-11">R</h4>
<p>In base R, we draw the scatterplot and add a linear line (<code>abline()</code>):</p>
<pre><code>plot(example_data$y ~ example_data$x)
abline(reg=glm(y ~ x, data = example_data))</code></pre>
<p><code>gplot2</code> adds a line with <code>geom_smooth()</code>:</p>
<pre><code>ggplot(example_data, aes(x, y)) + 
  geom_point() + 
  geom_smooth(method=&quot;glm&quot;, formula= y ~ x)</code></pre>
<p>By default <code>geom_smooth()</code> includes a 95% confidence interval around the line.</p>
</div>
<div class="column-center">
<h3 id="quadratic-lines-on-scatterplots">Quadratic Lines on Scatterplots</h3>
<p>We may want to put a nonlinear fit line on our plot. This is easy in both Stata and R.</p>
</div>
<div class="column-left">
<h4 id="stata-12">Stata</h4>
<p><code>qfit</code> generates a quadratic fit line.</p>
<pre><code>graph twoway ((scatter y x) || (qfit y x))</code></pre>
</div>
<div class="column-right">
<h4 id="r-12">R</h4>
<p>Quadratic fits are slightly awkward in base R:</p>
<pre><code>plot(example_data$y ~ example_data$x)
curve(predict(glm(y~x, data=example_data), 
  newdata=data.frame(wt=x)), add=T)</code></pre>
<p>They use the same syntax as linear fits in <code>gplot2</code>:</p>
<pre><code>ggplot(example_data, aes(x, y)) + 
  geom_point() + 
  geom_smooth(method=&quot;glm&quot;, formula= y ~ poly(x,2))</code></pre>
</div>
<div class="column-center">
<h2 id="predicted-values">Predicted Values</h2>
</div>
<div class="column-left">
<h4 id="stata-13">Stata</h4>
<p>You can generate predictions as a new variable in your data:</p>
<pre><code>predict xb pr_vals</code></pre>
<p>Or get predictions at set values with <code>prvalue</code>. You will need to install <code>prvalue</code> from a package such as <code>spost9_ado</code> using <code>net install spost9_ado.pkg</code></p>
<pre><code>prvalue , x(y=1 z=2)
prvalue , x(y=10 z=-1)</code></pre>
</div>
<div class="column-right">
<h4 id="r-13">R</h4>
<p>R uses the <code>predict()</code> function to generate predicted values.</p>
<pre><code>predict(example_model2)</code></pre>
<p>If you want to predict an outcome at specific values of a variable, you need to provide new data. The new data must have a value for every variable on the right hand side of the model. It accepts multiple rows to produce multiple predictions as well.</p>
<pre><code>predict(example_model2, 
        newdata=data.frame(y=1, z=2), 
        type=&quot;response&quot;)
predict(example_model2, 
        newdata=data.frame(y=rep(1,10), 
                           z=seq(-1,1, length.out=10)),
        type=&quot;response&quot;)</code></pre>
</div>
<div class="column-center">
<h2 id="plotting-predictions">Plotting Predictions</h2>
</div>
<div class="column-left">
<h4 id="stata-14">Stata</h4>
<p>Plotting predictions from a model at varying levels of two variables requires multiple <code>prgen</code> (from <code>spost9_ado</code>) calls:</p>
<pre><code>logit x_d1 y z
prgen y,from(0) to(8) generate(predval_a) n(30) x(z=-1)
prgen y,from(0) to(8) generate(predval_b) n(30) x(z=0)
prgen y,from(0) to(8) generate(predval_c) n(30) x(z=1)

graph twoway (line predval_ap1 predval_ax  || line predval_bp1 predval_bx || line predval_cp1 predval_cx )</code></pre>
<p>Note <code>prgen</code> works only with <code>logit</code> and not <code>glm</code></p>
<p>Or using <code>margins</code> and <code>marginsplot</code></p>
<pre><code>glm x_d1 y z, family(binomial) link(logit)
margins, at(y=(0(1)8) z=-1) ///
         at(y=(0(1)8) z=0) ///
         at(y=(0(1)8) z=1)
marginsplot</code></pre>
<p><code>margins</code> and <code>marginsplot</code> work with <code>glm</code> or <code>logit</code></p>
</div>
<div class="column-right">
<h4 id="r-14">R</h4>
<p><code>ggplot2</code> is well suited to making complex predicted value plots. Here we generate a range of <code>y</code> values from 0 to 8 in increments of 0.25. We do this for <em>each</em> value of z: -1, 0, and 1.</p>
<pre><code>pr_data &lt;- data.frame(y = rep(seq(0,8,0.25), each=3),
                      z = c(-1,0,1))
pr_data$predicted &lt;- 
   predict(example_model2, newdata = pr_data,
   type = &quot;response&quot;)
ggplot(pr_data, aes(y=predicted, x=y, group=z, col=z)) + 
   geom_line()</code></pre>
<p><code>ggeffects</code> streamlines this process by automatically generating the data and predictions:</p>
<pre><code>library(ggeffects)
example_model2 %&gt;% 
   ggpredict(terms=c(&quot;y [n=30]&quot;,&quot;z&quot;)) %&gt;% 
   plot()</code></pre>
<p>The <code>n=30</code> in terms forces <code>ggpredict()</code> to generate 30 values of <code>y</code>: this makes the lines smoother curves.</p>
</div>
<div class="column-center">
<h2 id="heteroskedasticity">Heteroskedasticity</h2>
<h3 id="residual-plots">Residual Plots</h3>
</div>
<div class="column-left">
<h4 id="stata-15">Stata</h4>
<pre><code>glm y x z
predict yres2, residual
predict yhat, xb
scatter yres2 yhat</code></pre>
</div>
<div class="column-right">
<h4 id="r-15">R</h4>
<p>Simple base R method:</p>
<pre><code>plot(residuals(example_model)~fitted(example_model))
plot(residuals(example_model)^2~fitted(example_model))</code></pre>
<p><code>broom</code>, <code>dplyr</code>, and <code>ggplot2</code> method:</p>
<pre><code>example_model %&gt;% 
  broom::augment() %&gt;% 
  ggplot(aes(y=.resid, x=.fitted)) + 
  geom_point()</code></pre>
</div>
<div class="column-center">
<h3 id="breusch-pagan-cook-weisburg-tests">Breusch-Pagan / Cook-Weisburg Tests</h3>
</div>
<div class="column-left">
<h4 id="stata-16">Stata</h4>
<p>We can run tests manually.</p>
<pre><code>glm y x z
predict yres2, residual

glm yres2 x z family(gauss) link(identity)
test x=z=0
glm yres2 yhat yhat2</code></pre>
<p>Or use <code>hettest</code> after an OLS run using <code>regress</code>.</p>
<pre><code>reg y x z
hettest</code></pre>
</div>
<div class="column-right">
<h4 id="r-16">R</h4>
<p>We can do this manually:</p>
<pre><code>example_data$yres2 &lt;- residuals(example_model)^2
glm(yres2 ~ x + z, data=example_data)

example_data$yhat &lt;- fitted(example_model)
example_data$yhat2 &lt;- fitted(example_model)^2
glm(yres2 ~ yhat + yhat2, data=example_data)</code></pre>
<p>Or <code>lmtest</code> contains a Breusch-Pagan test:</p>
<pre><code>lmtest::bptest(example_model)</code></pre>
</div>
<div class="column-center">
<h3 id="heteroskedasticity-consistent-robust-errors">Heteroskedasticity-Consistent / Robust Errors</h3>
</div>
<div class="column-left">
<h4 id="stata-17">Stata</h4>
<pre><code>glm y x z, family(gauss) link(identity) vce(robust)</code></pre>
</div>
<div class="column-right">
<h4 id="r-17">R</h4>
<p><code>sjstats</code> has a simple wrapper:</p>
<pre><code>sjstats::robust(example_model)</code></pre>
<p>Or we can do it with <code>lmtest</code>:</p>
<pre><code>lmtest::coeftest(example_model, vcov = vcovHC)</code></pre>
</div>
<div class="column-center">
<h3 id="resampling-bootstrapping">Resampling / Bootstrapping</h3>
</div>
<div class="column-left">
<h4 id="stata-18">Stata</h4>
<pre><code>glm y x z, family(gauss) link(identity) vce(bootstrap, reps(1000))</code></pre>
</div>
<div class="column-right">
<h4 id="r-18">R</h4>
<p>The <code>car</code> package provides a shortcut to <code>boot</code> for easy bootstrapped SEs.</p>
<pre><code>car::Boot(glm(y ~ x + z, data=example_data))</code></pre>
<p>We can also use <code>boot</code> directly:</p>
<pre><code>library(boot)

boot_glm &lt;- function(d,indices) {  
  d &lt;- d[indices,]  
  fit &lt;- glm(y ~ x + z, data = d)  
  return(coef(fit))  
}
boot(data = example_data, 
     statistic = boot_glm, 
     R = 1000) </code></pre>
<p>Or we do it manually using modern tidyverse commands:</p>
<pre><code>library(dplyr)
library(broom)
library(rsample)
library(tidyr)
library(purrr)

example_data %&gt;% 
  bootstraps(times=1000) %&gt;% 
  mutate(model = map(splits, 
                     function(x) glm(y ~ x + z, data=x)),
         coef_info = map(model, tidy)) %&gt;% 
  unnest(coef_info) %&gt;% 
  group_by(term) %&gt;%
  summarize(pe = mean(estimate),
            se = sd(estimate),
            low =  quantile(estimate, .025),
            high = quantile(estimate, .975))</code></pre>
</div>
<div class="column-center">
<h2 id="model-diagnostics">Model Diagnostics</h2>
<h3 id="partial-plots">Partial Plots</h3>
</div>
<div class="column-left">
<h4 id="stata-19">Stata</h4>
<p>We’ll create a variable to indicate the case number, then run <code>avplot</code>.</p>
<pre><code>generate case=_n
avplots, mlabel(case)</code></pre>
</div>
<div class="column-right">
<h4 id="r-19">R</h4>
<p><code>car</code> has an <code>avPlots()</code> function:</p>
<pre><code>car::avPlots(example_model)</code></pre>
<p>Or you can do it manually:</p>
<pre><code>example_data$case &lt;- 1:nrow(example_data)
res_x_z &lt;- residuals(glm(x~z, data=example_data))
res_y_z &lt;- residuals(glm(y~z, data=example_data)) 
plot(res_y_z~res_x_z)
text(res_x_z, res_y_z, labels=example_data$case)
abline(lm(res_y_z~res_x_z), col=&quot;blue&quot;)</code></pre>
</div>
<div class="column-center">
<h3 id="leverage">Leverage</h3>
</div>
<div class="column-left">
<h4 id="stata-20">Stata</h4>
<pre><code>predict leverage, hat</code></pre>
</div>
<div class="column-right">
<h4 id="r-20">R</h4>
<p><code>hatvalues()</code> produces… hat values.</p>
<pre><code>hatvalues(example_model)</code></pre>
<p><code>augment()</code> adds values to the data used to fit the model: <code>.hat</code> is the diagonal of the hat matrix.</p>
<pre><code>broom::augment(example_model)</code></pre>
</div>
<div class="column-center">
<h3 id="studentized-residuals">Studentized Residuals</h3>
</div>
<div class="column-left">
<h4 id="stata-21">Stata</h4>
<pre><code>predict studentres, rstudent</code></pre>
</div>
<div class="column-right">
<h4 id="r-21">R</h4>
<pre><code>rstudent(example_model)</code></pre>
</div>
<div class="column-center">
<h3 id="dffits-dfit">DFFITS / DFIT</h3>
</div>
<div class="column-left">
<h4 id="stata-22">Stata</h4>
<pre><code>predict dfits, dfits</code></pre>
</div>
<div class="column-right">
<h4 id="r-22">R</h4>
<p><code>dffits()</code> gets just the DFFITS values.</p>
<pre><code>dffits(example_model)</code></pre>
<p><code>influence.measures()</code> gets DFFITS and other influence measures.</p>
<pre><code>influence.measures(example_model)</code></pre>
</div>
<div class="column-center">
<h3 id="cooks-d">Cook’s D</h3>
</div>
<div class="column-left">
<h4 id="stata-23">Stata</h4>
<pre><code>predict cooksd, cooksd</code></pre>
</div>
<div class="column-right">
<h4 id="r-23">R</h4>
<p>For just Cook’s D values:</p>
<pre><code>cookds.distance(example_model)</code></pre>
<p>Or <code>augment()</code> can return the data with Cook’s D added for each row.</p>
<pre><code>broom::augment(example_model)</code></pre>
</div>
<div class="column-center">
<h3 id="dfbetas">DFBetas</h3>
</div>
<div class="column-left">
<h4 id="stata-24">Stata</h4>
<pre><code>dfbeta </code></pre>
</div>
<div class="column-right">
<h4 id="r-24">R</h4>
<p>For DFBetas alone:</p>
<pre><code>dfbetas(example_model)
</code></pre>
<p>Or DFBetas with other statistics:</p>
<pre><code>influence.measures(example_model)</code></pre>
</div>
<div class="column-center">
<h3 id="vif">VIF</h3>
</div>
<div class="column-left">
<h4 id="stata-25">Stata</h4>
<p>To produce variance inflation factors, just run <code>vif</code> after the model.</p>
<pre><code>vif</code></pre>
</div>
<div class="column-right">
<h4 id="r-25">R</h4>
<p><code>car</code> has a function for VIFs:</p>
<pre><code>car::vif(example_model)</code></pre>
</div>
<div class="column-center">
<h3 id="diagnostic-plots">Diagnostic Plots</h3>
</div>
<div class="column-left">
<h4 id="stata-26">Stata</h4>
<p>Stata has individual functions for these but no comparable function for multiple diagnostic plots. You’d normally want to run them individually anyway.</p>
</div>
<div class="column-right">
<h4 id="r-26">R</h4>
<p>Just running <code>plot()</code> on an R model will produce a series of diagnostic plots. You must hit <code>ENTER</code> in the console to browse through them.</p>
<pre><code>plot(example_model)</code></pre>
<p>This produces the following plots (in order):</p>
<ul>
<li>Residuals vs fitted values</li>
<li>Q-Q Plot</li>
<li>Scale-Location</li>
<li>Residuals vs. Leverage</li>
</ul>
</div>
<div class="column-center">
<h3 id="removingselecting-cases">Removing/Selecting Cases</h3>
</div>
<div class="column-left">
<h4 id="stata-27">Stata</h4>
<p>To be added.</p>
</div>
<div class="column-right">
<h4 id="r-27">R</h4>
<p>There are many ways to remove cases in R. You can remove one or more observations by index:</p>
<pre><code>data_subset &lt;- example_data[-10,]
data_subset &lt;- example_data[-c(10,25),]</code></pre>
<p>The first removes the 10th case, the second the 10th and 25th cases. You can also remove cases by criteria:</p>
<pre><code>data_subset &lt;- example_data[x &gt;= 0, ]</code></pre>
<p>This would drop any cases for which <code>x</code> is less than zero. You can do this in <code>dplyr</code> as well:</p>
<pre><code>data_subset &lt;- example_data %&gt;% 
   filter(x &gt;= 0)</code></pre>
<p>You can use any standard logical operators to subset data this way. <a href="https://clanfear.github.io/CSSS508/Lectures/Week3/CSSS508_Week3_dplyr.html#12">See these lecture slides for more detail</a>.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
